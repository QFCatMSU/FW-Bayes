---
title: Divergent transitions revisited  
title-slide-attributes:
    data-background-image: "https://qfcatmsu.github.io/Images/dark-big.png"  
    data-background-size: "40%"
    data-background-position: "6% 95%"
subtitle: FW 891 <br> [Click here to view presentation online](https://qfcatmsu.github.io/FW-Bayes/week6/lec9.html){style="position:absolute;top:40%;left:35%;font-size:20px;"}
author: Christopher Cahill
date: 16 October 2023
date-format: "D MMMM YYYY"
format: 
  revealjs:
    css: "https://qfcatmsu.github.io/css/presStyle.css"
    slide-number: c/t  
    theme: simple 
editor: visual
highlight-style: kate
---

## Purpose

-   Introduce the concept
-   The Devil's funnel (spooky seazn ðŸ‘»)
-   Examine some ways to track down where things are going wrong in a model
-   Look at some more complicated examples
    -   Example of how this stuff manifests in real-world models

## Purpose

-   Refresher
-   Discuss divergent transitions in more detail
-   Reparameterizing mixed effects models to deal or attempt to deal with divergent transitions
-   This lecture/material draws *heavily* from McElreath (2023)'s Statistical Rethinking
-   This lecture/material draws *heavily* from <https://betanalpha.github.io/assets/case_studies/identifiability.html>
-   This lecture/material draws *heavily* from Stan resources

## Before we get started

```{R echo = T, eval = F}
install.packages("devtools")
devtools::install_github("QFCatMSU/gg-qfc")
library(ggqfc)
```

## Testing that installation

```{R echo = T, eval = F}
pp_roll() # test posterior predictive function  

```

## A decent numerical computing rule

::: {style="font-size:30px"}
"As soon as you start trusting \[the machine\], \[the machine\] will betray your trust"
:::

![](images/rage.jpg){fig-align="center" width="700" height="500"}

[McElreath 2023]{.footerRight}

## Divergent transitions (DTs) and non-centered priors

-   We have been talking about DTs all semester, and I promised to explain them later
-   When working with hierarchical models, DTs are commonplace
-   That means we need knowledge about what they are how to fix them

## Refresher on divergent transitions

::: {style="font-size:35px"}
-   Most important warning kicked out of Stan
-   Hamiltonian MC provides internal checks on both efficiency and accuracy of the simulation, and are kicked out "for free" during the mini-physics particle simulation
    -   Recall that HMC simulates a frictionless particle trajectory
    -   In any given transition of the simulation, the total energy at the start of the simulation should equal energy at the end
    -   When this doesn't happen, the energy is "divergent"
-   Geometric interpretation, posterior is difficult to sample

[McElreath 2023]{.footerRight}
:::

## Divergent transitions after warmup

::: {style="font-size:35px"}
-   Critical to recognize that divergent transitions cannot be safely ignored if completely reliable inference is desired
    -   Proceed at your own risk: you may not be faithfully representing the posterior uncertainty if you ignore DTs
-   If you only get a few divergences and good Rhat values and ESS, the resulting posterior is often good enough to move forward
-   There are cases where a small number of divergences without any pattern in their locations can be shown to be unimportant, but this requires a lot of simulation and math
-   Extensive discussion/information

![](images/tidybayes.png){style="width:185px; position: absolute; margin-top: -4%; right:25%;"}![](images/logo_website.png){style="width:150px; position: absolute; margin-top: -3%; right:6%;"}
:::

## How do we deal with divergent transitions

-   Or more precisely, what have we done to date in this class to deal with divergent transitions?

## How do we deal with divergent transitions

-   Or more precisely, what have we done to date in this class to deal with divergent transitions?

-   We will proceed assuming we have changed adapt_delta, etc.

## How do we deal with divergent transitions

-   Or more precisely, what have we done to date in this class to deal with divergent transitions?

-   We will proceed assuming we have changed adapt_delta, etc.

-   Recall this Stan reference

    -   [Diagnosing and eliminating divergences](https://mc-stan.org/docs/reference-manual/divergent-transitions.html)

## How to determine if DTs are present

-   cmdstanr should warn us
-   fit\$cmdstan_diagnose() should show us if there are any runtime warnings (including DTs)

## Eight schools example via `bayesplot`

\-[See this link](https://cran.r-project.org/web/packages/bayesplot/vignettes/visual-mcmc-diagnostics.html) for Eight Schools example reference

<br>

-   The data

<br>

```{R echo = T, eval = T}
schools_dat <- list(
  J = 8,                                     # number of schools
  y = c(28,  8, -3,  7, -1,  1, 18, 12),     # standardized test scores
  sigma = c(15, 10, 16, 11,  9, 11, 10, 18)  # standard deviations 
)
```

## The Eight Schools model

$$
\begin{aligned}
y_{j} & \sim \operatorname{Normal}\left(\theta_{j}, \sigma_{j}\right), \quad j=1, \ldots, J \\
\theta_{j} & \sim \operatorname{Normal}(\mu, \tau), \quad j=1, \ldots, J \\
\mu & \sim \operatorname{Normal}(0,10) \\
\tau & \sim \operatorname{half}-\operatorname{Cauchy}(0,10).
\end{aligned}
$$

## The Cauchy distribution

![](images/Cauchy.png){fig-align="center" width="800" height="500"}

[<https://en.wikipedia.org/wiki/Cauchy_distribution>]{.footerRight}

## The `schools_cp.stan` model

::: {style="font-size: 90%;"}
```{javascript eval = F, echo = T}
data {
  int<lower=0> J;
  vector[J] y;
  vector<lower=0>[J] sigma;
}
parameters {
  real mu;
  real<lower=0> tau;
  vector[J] theta;
}
model {
  mu ~ normal(0, 10);
  tau ~ cauchy(0, 10);
  theta ~ normal(mu, tau);
  y ~ normal(theta, sigma);
}
```
:::

-   Note this is a *centered parameterization*, hence the 'cp'

## Calling `schools_cp.stan` from R

```{R echo = T, eval = T}
library("bayesplot")
library("ggplot2")
library("cmdstanr")   
library("tidyverse")
color_scheme_set("darkgray")
mod_cp <- cmdstan_model("src/schools_cp.stan")


```

## Calling `schools_cp.stan` from R

```{R echo = T, eval = T}
fit <- mod_cp$sample(
  data = schools_dat,
  seed = 1, 
  chains = 4, 
  iter_warmup = 1000, 
  iter_sampling = 1000, 
  parallel_chains = 4, 
  refresh = 0 
)

```

## Inspecting the fit

::: {style="font-size: 75%;"}
```{R echo = T, eval = T}
fit$cmdstan_diagnose()
```
:::

## Calling `schools_cp.stan` from R

```{R echo = T, eval = T}
fit <- mod_cp$sample(
  data = schools_dat,
  seed = 1, 
  chains = 4, 
  iter_warmup = 1000, 
  iter_sampling = 1000, 
  parallel_chains = 4, 
  adapt_delta = 0.999, 
  refresh = 0 
)

```

## Inspecting the fit -- `adapt_delta` = 0.999

::: {style="font-size: 75%;"}
```{R echo = T, eval = T}
fit$cmdstan_diagnose()
```
:::

## Inspecting the fit

```{R echo = T, eval = F}

post <- fit$draws(format = "df") 
np <- nuts_params(fit)
mcmc_pairs(post, np = np, pars = c("mu","tau","theta[1]"),
           off_diag_args = list(size = 0.75), 
           np_style = pairs_style_np(div_color = "firebrick", 
           div_size = 2, div_shape = 10))
```

## Inspecting the fit

```{R echo = F, eval = T}

post <- fit$draws(format = "df") 
np <- nuts_params(fit)
mcmc_pairs(post, np = np, pars = c("mu","tau","theta[1]"),
           off_diag_args = list(size = 0.75), 
           np_style = pairs_style_np(div_color = "firebrick", div_size = 2, div_shape = 19))
```

## Some other examples showing how to root out DTs

## Pairs plots as a (the?) key tool

![](images/dt_stan_forum.jpeg){fig-align="center" width="800" height="600"}

## Coordinate plots

-   Coordinate plots have one dimension per parameter along the horizontal axis and each set of connected line segments represents a single MCMC draw (i.e., a vector of length equal to the number of parameters)
    -   i.e., a single row of the posterior
-   Can help narrow down where in the model specifically there are problems

## Coordinate plots

![](images/coordplot.png){fig-align="center" width="800" height="600"}

## Another example from Discourse

![](images/dt_stan_forum2.png){fig-align="center" width="800" height="600"}

## Another example from Discourse

-   See this thread on the Stan Discourse discussion on this specific plot:

<https://discourse.mc-stan.org/t/divergent-transitions-in-hierarchical-model-with-random-effects/22645/10>

## Even more examples from Discourse

![](images/dt_stan_forum3.png){fig-align="center" width="800" height="600"}

## Even more examples from Discourse

-   See discussion for previous slide here:

<https://discourse.mc-stan.org/t/divergent-transitions-when-modeling-changing-circular-concentration-von-mises-dist/4143>